#!/bin/bash
port=10241                  # Local port on which to set up the proxy service.
target=hydra.sr.bham.ac.uk  # Remote machine (through which the connection is bounced).
user=will                   # User on remote machine.

stub="ssh -fC2qTN -D"
command="$stub $port $user@$target"
proc=$(ps aux | grep "$stub" | grep -v grep | awk '{ print $2 }')
if [[ $1 == -k ]]; then
    # Disable SOCKS proxy (for Mac).
    if [[ -x $(which networksetup) ]]; then
        networksetup -setsocksfirewallproxystate Wi-Fi off
    fi

    if [[ -n $proc ]]; then
        echo "Killing proxy."
        kill $proc
    else
        echo "No proxy exists."
    fi
else
    if [[ -z $proc ]]; then
        echo "Starting proxy on port $port to $user@$target."
    else
        $0 -k > /dev/null
        echo "Renewing proxy."
    fi

    $command

    # Enable SOCKS proxy (for Mac).
    if [[ -x $(which networksetup) ]]; then
        networksetup -setsocksfirewallproxystate Wi-Fi on
    fi
fi
