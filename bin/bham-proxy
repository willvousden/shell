#!/usr/bin/env bash

port=10241                  # Local port on which to set up the proxy service.
host=hydra.sr.bham.ac.uk    # Remote machine (through which the connection is bounced).
user=                       # User on remote machine (blank for default).
device=Wi-Fi

stub="ssh -fC2qTN -D"
target=$host
if [[ -n $user ]]; then
    target=$user@$host
fi

function get_pid {
    echo $(ps aux | grep "$stub" | grep -v grep | awk '{ print $2 }')
}

if [[ $1 == -k ]]; then
    # Kill the proxy.

    # Disable SOCKS proxy (for Mac).
    if [[ -x $(which networksetup) ]]; then
        sudo networksetup -setsocksfirewallproxystate $device off
    fi

    pid=$(get_pid)
    if [[ -n $pid ]]; then
        echo "Killing proxy with PID: $pid."
        kill $pid
    else
        echo "No proxy exists."
    fi
else
    # Set up the proxy.

    if [[ -z $(get_pid) ]]; then
        echo "Starting proxy on port $port to $target."
    else
        $0 -k > /dev/null
        echo "Renewing proxy."
    fi

    $stub $port $target
    echo "Proxy started with PID: $(get_pid)."

    # Enable SOCKS proxy (for Mac).
    if [[ -x $(which networksetup) ]]; then
        sudo networksetup -setsocksfirewallproxy $device localhost $port
        sudo networksetup -setsocksfirewallproxystate $device on
    fi
fi
